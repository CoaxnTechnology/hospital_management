const graphs = {
    'bip': {
        'p3': [[11, 12.08], [12, 15.81], [13, 19.47], [14, 23.05], [15, 26.56], [16, 29.97], [17, 33.32], [18, 36.55], [19, 39.76], [20, 42.85], [21, 45.86], [22, 48.79], [23, 51.63], [24, 54.38], [25, 57.04], [26, 59.62], [27, 62.12], [28, 64.5], [29, 66.84], [30, 69.07], [31, 71.22], [32, 73.3], [33, 75.24], [34, 77.14], [35, 78.94], [36, 80.64], [37, 82.27], [38, 83.78], [39, 85.22], [40, 86.57], [41, 87]],
        'p97': [[11, 18.63], [12, 22.92], [13, 27.12], [14, 31.23], [15, 35.23], [16, 39.08], [17, 42.87], [18, 46.56], [19, 50.18], [20, 53.64], [21, 57], [22, 60.3], [23, 63.45], [24, 66.5], [25, 69.42], [26, 72.27], [27, 75], [28, 77.6], [29, 80.09], [30, 82.52], [31, 84.8], [32, 87], [33, 89.04], [34, 91], [35, 92.83], [36, 94.56], [37, 96.19], [38, 97.66], [39, 99.05], [40, 100.31], [41, 101]],
        'p50': [[11, 15.36], [12, 19.4], [13, 23.3], [14, 27.14], [15, 30.89], [16, 34.53], [17, 38.12], [18, 41.58], [19, 45], [20, 48.22], [21, 51.43], [22, 54.53], [23, 57.51], [24, 60.42], [25, 63.25], [26, 65.94], [27, 68.55], [28, 71.03], [29, 73.5], [30, 75.8], [31, 78], [32, 80.16], [33, 82.14], [34, 84.07], [35, 85.9], [36, 87.61], [37, 89.24], [38, 90.7], [39, 92.1], [40, 93.45], [41, 94]],
    },
    'pc': {
        'p3': [[16, 105.8], [17, 118.67], [18, 131.08], [19, 143], [20, 154.53], [21, 165.41], [22, 176.12], [23, 186.32], [24, 196.19], [25, 205.5], [26, 214.44], [27, 222.87], [28, 231], [29, 238.4], [30, 245.86], [31, 252.54], [32, 258.86], [33, 264.62], [34, 270.14], [35, 275.33], [36, 279.79], [37, 283.9], [38, 287.63], [39, 290.88], [40, 293]],
        'p97': [[16, 136.11], [17, 150.39], [18, 164.11], [19, 177.48], [20, 190.54], [21, 203.09], [22, 215.15], [23, 226.76], [24, 238], [25, 248.81], [26, 259.23], [27, 269.13], [28, 278.57], [29, 287.56], [30, 296], [31, 304.27], [32, 312], [33, 319.1], [34, 325.91], [35, 332.16], [36, 338], [37, 343.34], [38, 348.29], [39, 352.67], [40, 356]],
        'p50': [[16, 120.86], [17, 134.49], [18, 147.55], [19, 160.29], [20, 172.47], [21, 184.21], [22, 195.74], [23, 206.64], [24, 217.18], [25, 227.32], [26, 236.72], [27, 246], [28, 254.77], [29, 263], [30, 270.84], [31, 278.33], [32, 285.29], [33, 292], [34, 298.1], [35, 303.62], [36, 308.81], [37, 313.52], [38, 317.88], [39, 321.86], [40, 324]]
    },
    'pa': {
        'p3': [[15, 80.7],[16, 91.3],[17, 101.7],[18, 111.8],[19, 122],[20, 132],[21, 141.6],[22, 151.4],[23, 160.9],[24, 170.2],[25, 179.3],[26, 188.4],[27, 197.3],[28, 206.2],[29, 214.7],[30, 223.2],[31, 231.6],[32, 239.7],[33, 247.8],[34, 255.6],[35, 263.2],[36, 271],[37, 278.3],[38, 285.6],[39, 292.7],[40, 298]],
        'p97': [[15, 108.8],[16, 121.6],[17, 134],[18, 146.6],[19, 158.8],[20, 171],[21, 183],[22, 194.7],[23, 206.3],[24, 218],[25, 229.3],[26, 240.6],[27, 251.6],[28, 262.6],[29, 273.3],[30, 283.7],[31, 294.4],[32, 304.6],[33, 314.8],[34, 324.8],[35, 334.5],[36, 344.3],[37, 353.8],[38, 363],[39, 372.2],[40, 380]],
        'p50': [[15, 95],[16, 106.4],[17, 118],[18, 129.2],[19, 140.4],[20, 151.4],[21, 162.3],[22, 173],[23, 183.6],[24, 194],[25, 204.4],[26, 214.5],[27, 224.5],[28, 234.4],[29, 244],[30, 253.6],[31, 263],[32, 272.2],[33, 281.2],[34, 290.2],[35, 298.8],[36, 307.4],[37, 316],[38, 324.7],[39, 332.4],[40, 339]]
    },
    'femur': {
        'p3': [[12, 2.76],[13, 6.09],[14, 9.4],[15, 12.56],[16, 15.7],[17, 18.74],[18, 21.69],[19, 24.59],[20, 27.42],[21, 30.12],[22, 32.83],[23, 35.34],[24, 37.89],[25, 40.33],[26, 42.66],[27, 44.95],[28, 47.13],[29, 49.22],[30, 51.3],[31, 53.26],[32, 55.12],[33, 56.96],[34, 58.69],[35, 60.33],[36, 61.9],[37, 63.4],[38, 64.81],[39, 66.16],[40, 67.42],[41, 68]],
        'p97': [[12, 10],[13, 13.65],[14, 17.27],[15, 20.77],[16, 24.18],[17, 27.53],[18, 30.8],[19, 33.91],[20, 37.03],[21, 40],[22, 42.91],[23, 45.71],[24, 48.42],[25, 51.08],[26, 53.62],[27, 56.09],[28, 58.45],[29, 60.72],[30, 62.92],[31, 65.04],[32, 67.07],[33, 69.03],[34, 70.84],[35, 72.63],[36, 74.3],[37, 75.89],[38, 77.41],[39, 78.84],[40, 80.17],[41, 81]],
        'p50': [[12, 6.33],[13, 9.88],[14, 13.33],[15, 16.66],[16, 19.95],[17, 23.12],[18, 26.23],[19, 29.25],[20, 32.23],[21, 35.05],[22, 37.87],[23, 40.5],[24, 43.16],[25, 45.69],[26, 48.17],[27, 50.53],[28, 52.8],[29, 54.94],[30, 57.13],[31, 59.15],[32, 61.11],[33, 63],[34, 64.76],[35, 66.47],[36, 68.13],[37, 69.63],[38, 71.11],[39, 72.48],[40, 73.79],[41, 74]]
    },
    'poids': {
        'p3': [[17, 148.35], [18, 202.89], [19, 251.15], [20, 297.62], [21, 346.17], [22, 400.08], [23, 461.98], [24, 533.93], [25, 617.35], [26, 713.05], [27, 821.24], [28, 941.51], [29, 1072.85], [30, 1213.62], [31, 1361.58], [32, 1513.89], [33, 1667.06], [34, 1817.03], [35, 1959.12], [36, 2088.00], [37, 2197.79], [38, 2281.95]],
        'p97': [[17, 215.72], [18, 282.62], [19, 347.79], [20, 415.71], [21, 490.26], [22, 574.70], [23, 671.69], [24, 783.27], [25, 910.85], [26, 1055.26], [27, 1216.71], [28, 1394.78], [29, 1588.47], [30, 1796.13], [31, 2015.52], [32, 2243.80], [33, 2477.49], [34, 2712.53], [35, 2944.21], [36, 3167.25], [37, 3375.73], [38, 3563.12]],
        'p50': [[17, 182.04], [18, 242.75], [19, 299.47], [20, 356.66], [21, 418.22], [22, 487.39], [23, 566.84], [24, 658.60], [25, 764.10], [26, 884.16], [27, 1018.97], [28, 1168.15], [29, 1330.66], [30, 1504.87], [31, 1688.55], [32, 1878.84], [33, 2072.28], [34, 2264.78], [35, 2451.66], [36, 2627.63], [37, 2786.76], [38, 2922.53]]
    }
};

function updateGraph(graph, points) {
    let options = {
        xaxes: [
            {position: 'bottom', axisLabel: 'SA'},
        ],
        yaxes: [
            {position: 'left', axisLabel: 'mm'},
        ],
        legend: {
            position: "se",
            show: true,
            noColumns: 1,
            backgroundOpacity: 0.5,
            backgroundColor: 'green',
            container: null
        }
    };


    $("#graph-" + graph).empty();
    let data = [
        {
            label: "3ème",
            data: graphs[graph]['p3'],
            color: '#29b6f6',
        },
        {
            label: "97ème",
            data: graphs[graph]['p97'],
            color: '#29b6f6',
        },
        {
            label: "50ème",
            data: graphs[graph]['p50'],
            color: '#78002e'
        }
    ];
    const fColors = ["#80e27e", "#ffad42", "#7953d2"];
    let i=0;
    _.each(points, (p, k) => data.push({
        label: k, data: p, color: fColors[i],
        points: {
            show: true,
            radius: 5,
            fillColor: fColors[i++],
            symbol: "diamond"
        }
    }));
    $.plot("#graph-" + graph, data, options);
}


function chargerMesures(grossesseId) {
    return new Promise((resolve, reject) => {
        $.get(`/grossesses/${grossesseId}/mesures/`)
            .done(function (result) {
                //console.log('Received mesures', result)
                //let mesures = JSON.parse(result);
                //mesures = result;
                console.info('Received mesures', result);
                resolve(result);
            })
            .fail(function () {
                console.error("Impossible de charger les mesures");
            });
    });
}

function updateAllGraphs(mesures) {
    const graphsList = ['bip', 'poids', 'femur', 'pa', 'pc'];
    _.each(graphsList, graph => {
        let points = {};
        let terme = calcTermeSA(moment(grossesse.ddr, 'YYYY-MM-DD'), grossesse.cycle);
        for (let i = 0; i < 3; i++) {
            const id = `Foetus ${i + 1}`;
            if (mesures[id])
                points[id] = mesures[id][graph];
        }
        updateGraph(graph, points);
    });
}

$(document).ready(() => {
    //var data = [[0, 3], [4, 8], [8, 5], [9, 13]];
    chargerMesures(grossesse.id).then(mesures => {
        console.log('Mesures recues', mesures);
        updateAllGraphs(mesures);
    });

    EventManager.subscribe("consultation:updated", function (event) {
        console.info('Event consultation:updated', event);
        chargerMesures(grossesse.id).then(mesures => {
            console.log('Mesures recues', mesures);
            updateAllGraphs(mesures);
        });
    });

});